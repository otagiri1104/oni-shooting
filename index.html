<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Oni Shooting</title>
<style>
  body {
    margin: 0;
    background: #111;
    overflow: hidden;
  }
  canvas {
    display: block;
    margin: auto;
    background: #000;
  }
</style>
</head>
<body>

<canvas id="game"></canvas>

<script>
/* ===== Canvas ===== */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

/* ===== 画像 ===== */
const playerImage = new Image();
playerImage.src = "onigiri.png";

const oniImage = new Image();
oniImage.src = "teki.png";

const hukuImage = new Image();
hukuImage.src = "huku.png";

/* ===== 状態 ===== */
let score = 0;
let gameOver = false;
let paused = false;

/* ===== サイズ ===== */
function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;

  if (canvas.width < 80) {
    gameOver = true;
  }
}
window.addEventListener("resize", () => {
  paused = true;
  resizeCanvas();
  setTimeout(() => {
    if (!gameOver) paused = false;
  }, 300);
});
resizeCanvas();

/* ===== プレイヤー ===== */
const player = {
  x: 0,
  y: 0,
  width: 48,
  height: 48,
  speed: 5
};
player.x = canvas.width / 2 - player.width / 2;
player.y = canvas.height - 60;

/* ===== 入力 ===== */
const keys = {};
document.addEventListener("keydown", e => keys[e.code] = true);
document.addEventListener("keyup", e => keys[e.code] = false);

/* ===== 弾 ===== */
const bullets = [];
const BULLET_COOLDOWN = 500; // 1秒2発
let lastShotTime = 0;

function shoot() {
  const now = performance.now();
  if (now - lastShotTime < BULLET_COOLDOWN) return;

  bullets.push({
    x: player.x + player.width / 2,
    y: player.y,
    radius: 4,
    speed: 8
  });
  lastShotTime = now;
}

/* ===== 敵 ===== */
const enemies = [];
let spawnTimer = 0;

function getEnemySpeed() {
  let speed = 1.5 + score / 1500;

  if (score > 1200) {
    speed += (score - 1200) / 1200;
  }
  if (score > 3500) {
    speed += (score - 3500) / 800;
  }
  return Math.min(speed, 6);
}

function spawnEnemy() {
  const isHuku = Math.random() < 0.1;
  enemies.push({
    x: Math.random() * (canvas.width - 48),
    y: -48,
    width: 48,
    height: 48,
    speed: getEnemySpeed(),
    type: isHuku ? "huku" : "normal"
  });
}

/* ===== 更新 ===== */
function update() {
  if (gameOver || paused) return;

  if (keys["ArrowLeft"] && player.x > 0) {
    player.x -= player.speed;
  }
  if (keys["ArrowRight"] && player.x < canvas.width - player.width) {
    player.x += player.speed;
  }

  if (keys["Space"]) shoot();

  bullets.forEach(b => b.y -= b.speed);
  for (let i = bullets.length - 1; i >= 0; i--) {
    if (bullets[i].y < -10) bullets.splice(i, 1);
  }

  spawnTimer++;
  if (spawnTimer > 60) {
    spawnEnemy();
    spawnTimer = 0;
  }

  for (let i = enemies.length - 1; i >= 0; i--) {
    const e = enemies[i];
    e.y += e.speed;

    if (e.y > canvas.height) {
      if (e.type !== "huku") {
        gameOver = true;
        return;
      }
      enemies.splice(i, 1);
      continue;
    }

    for (let j = bullets.length - 1; j >= 0; j--) {
      const b = bullets[j];
      if (
        b.x > e.x &&
        b.x < e.x + e.width &&
        b.y > e.y &&
        b.y < e.y + e.height
      ) {
        bullets.splice(j, 1);
        enemies.splice(i, 1);

        if (e.type === "huku") {
          gameOver = true;
          return;
        }
        score++;
        break;
      }
    }
  }
}

/* ===== 描画 ===== */
function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  ctx.drawImage(playerImage, player.x, player.y, player.width, player.height);

  ctx.fillStyle = "yellow";
  bullets.forEach(b => {
    ctx.beginPath();
    ctx.arc(b.x, b.y, b.radius, 0, Math.PI * 2);
    ctx.fill();
  });

  enemies.forEach(e => {
    const img = e.type === "huku" ? hukuImage : oniImage;
    ctx.drawImage(img, e.x, e.y, e.width, e.height);
  });

  ctx.fillStyle = "white";
  ctx.font = "16px sans-serif";
  ctx.fillText(`SCORE: ${score}`, 10, 20);

  if (gameOver) {
    ctx.fillStyle = "rgba(0,0,0,0.7)";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "white";
    ctx.font = "28px sans-serif";
    ctx.textAlign = "center";
    ctx.fillText("GAME OVER", canvas.width / 2, canvas.height / 2);
  }
}

/* ===== ループ ===== */
function loop() {
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();
</script>

</body>
</html>
