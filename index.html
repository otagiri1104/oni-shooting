<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>Oni Shooter</title>
<style>
  body {
    margin: 0;
    background: #111;
    color: #fff;
    overflow: hidden;
    font-family: sans-serif;
  }
  #ui {
    position: fixed;
    top: 10px;
    left: 10px;
    z-index: 10;
  }
  canvas {
    display: block;
    margin: 0 auto;
    background: #222;
  }
</style>
</head>
<body>

<div id="ui">
  <div>Score: <span id="score">0</span></div>
  <div id="status"></div>
</div>

<canvas id="game"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const scoreEl = document.getElementById("score");
const statusEl = document.getElementById("status");

let score = 0;
let gameOver = false;
let paused = false;

// ====== サイズ ======
function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;

  // 横幅が狭すぎる場合は即終了
  if (canvas.width < 80) {
    endGame("Canvas too small");
  }
}
window.addEventListener("resize", () => {
  paused = true;
  statusEl.textContent = "RESIZE PAUSE";
  resizeCanvas();
  setTimeout(() => {
    if (!gameOver) {
      paused = false;
      statusEl.textContent = "";
    }
  }, 300);
});
resizeCanvas();

// ====== プレイヤー ======
const player = {
  x: canvas.width / 2,
  y: canvas.height - 60,
  width: 40,
  height: 40,
  speed: 6
};

// ====== 弾 ======
const bullets = [];
const BULLET_COOLDOWN = 500; // 1秒2発
let lastShotTime = 0;

// ====== 敵 ======
const enemies = [];
let enemyTimer = 0;

// ====== 入力 ======
const keys = {};
window.addEventListener("keydown", e => keys[e.key] = true);
window.addEventListener("keyup", e => keys[e.key] = false);

// ====== 敵スピード（現状＋2段階追加） ======
function getEnemySpeed() {
  // 第1段階（現状そのまま）
  let speed = 1.5 + score / 1500;

  // 第2段階
  if (score > 1200) {
    speed += (score - 1200) / 1200;
  }

  // 第3段階
  if (score > 3500) {
    speed += (score - 3500) / 800;
  }

  return Math.min(speed, 6);
}

// ====== 敵生成 ======
function spawnEnemy() {
  const isHuku = Math.random() < 0.1;

  enemies.push({
    x: Math.random() * (canvas.width - 40),
    y: -40,
    width: 40,
    height: 40,
    speed: getEnemySpeed(),
    type: isHuku ? "huku" : "normal"
  });
}

// ====== 更新 ======
function update() {
  if (gameOver || paused) return;

  // プレイヤー移動
  if (keys["ArrowLeft"]) {
    player.x -= player.speed;
  }
  if (keys["ArrowRight"]) {
    player.x += player.speed;
  }
  player.x = Math.max(0, Math.min(canvas.width - player.width, player.x));

  // 発射（クールタイム）
  if (keys[" "] || keys["Space"]) {
    const now = performance.now();
    if (now - lastShotTime > BULLET_COOLDOWN) {
      bullets.push({
        x: player.x + player.width / 2 - 4,
        y: player.y,
        width: 8,
        height: 16,
        speed: 10
      });
      lastShotTime = now;
    }
  }

  // 弾更新
  for (let i = bullets.length - 1; i >= 0; i--) {
    bullets[i].y -= bullets[i].speed;
    if (bullets[i].y < -20) bullets.splice(i, 1);
  }

  // 敵生成
  enemyTimer++;
  if (enemyTimer > 60) {
    spawnEnemy();
    enemyTimer = 0;
  }

  // 敵更新
  for (let i = enemies.length - 1; i >= 0; i--) {
    const e = enemies[i];
    e.y += e.speed;

    // hukuは落下しきってもペナルティなし
    if (e.y > canvas.height) {
      if (e.type !== "huku") {
        endGame("Enemy escaped");
        return;
      } else {
        enemies.splice(i, 1);
        continue;
      }
    }

    // プレイヤー接触
    if (
      e.x < player.x + player.width &&
      e.x + e.width > player.x &&
      e.y < player.y + player.height &&
      e.y + e.height > player.y
    ) {
      endGame("Hit");
      return;
    }

    // 弾との衝突
    for (let j = bullets.length - 1; j >= 0; j--) {
      const b = bullets[j];
      if (
        b.x < e.x + e.width &&
        b.x + b.width > e.x &&
        b.y < e.y + e.height &&
        b.y + b.height > e.y
      ) {
        bullets.splice(j, 1);
        enemies.splice(i, 1);

        // hukuを撃ったら即ゲームオーバー
        if (e.type === "huku") {
          endGame("Shot huku");
          return;
        }

        score++;
        scoreEl.textContent = score;
        break;
      }
    }
  }
}

// ====== 描画 ======
function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // プレイヤー
  ctx.fillStyle = "#4af";
  ctx.fillRect(player.x, player.y, player.width, player.height);

  // 弾
  ctx.fillStyle = "#fff";
  bullets.forEach(b =>
    ctx.fillRect(b.x, b.y, b.width, b.height)
  );

  // 敵
  enemies.forEach(e => {
    ctx.fillStyle = e.type === "huku" ? "#f44" : "#6f6";
    ctx.fillRect(e.x, e.y, e.width, e.height);
  });
}

// ====== ゲームオーバー ======
function endGame(reason) {
  gameOver = true;
  statusEl.textContent = "GAME OVER: " + reason;
}

// ====== ループ ======
function loop() {
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();
</script>

</body>
</html>
