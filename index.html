<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Oni Shooting</title>
<style>
  body {
    margin: 0;
    background: #111;
  }
  canvas {
    display: block;
    margin: auto;
    background: #000;
  }
</style>
</head>
<body>

<canvas id="game" width="400" height="600"></canvas>

<script>
/* ===== Canvas ===== */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

/* ===== 定数 ===== */
const MIN_CANVAS_WIDTH = 120;
const SHOT_INTERVAL = 250; // ms

/* ===== 画像 ===== */
const oniImage = new Image();
oniImage.src = "teki.png";

const hukuImage = new Image();
hukuImage.src = "huku.png";

const playerImage = new Image();
playerImage.src = "onigiri.png";

/* ===== ゲーム状態 ===== */
let timeLeft = 30;
let score = 0;
let gameOver = false;
let lastShotTime = 0;

/* ===== プレイヤー ===== */
const player = {
  x: canvas.width / 2,
  y: canvas.height - 50,
  width: 48,
  height: 48,
  speed: 5
};

/* ===== 配列 ===== */
let bullets = [];
let enemies = [];

/* ===== 敵出現 ===== */
let spawnInterval = 1000;
let lastSpawnTime = 0;

/* ===== 入力 ===== */
const keys = {};
document.addEventListener("keydown", e => {
  keys[e.code] = true;
});
document.addEventListener("keyup", e => {
  keys[e.code] = false;
});

/* ===== 弾 ===== */
function shoot(time) {
  if (time - lastShotTime < SHOT_INTERVAL) return;

  lastShotTime = time;
  bullets.push({
    x: player.x,
    y: player.y - player.height / 2,
    radius: 4,
    speed: 7
  });
}

/* ===== 敵生成 ===== */
function spawnEnemy() {
  const isHuku = Math.random() < 0.1;

  enemies.push({
    x: Math.random() * (canvas.width - 40) + 20,
    y: -40,
    width: 48,
    height: 48,
    speed: 1.5 + score / 1500,
    type: isHuku ? "huku" : "normal"
  });
}

/* ===== 更新 ===== */
function update(time) {
  if (gameOver) return;

  /* 画面幅チェック */
  if (canvas.width < MIN_CANVAS_WIDTH) {
    gameOver = true;
    return;
  }

  /* 移動 */
  if (keys["ArrowLeft"] && player.x > player.width / 2) {
    player.x -= player.speed;
  }
  if (keys["ArrowRight"] && player.x < canvas.width - player.width / 2) {
    player.x += player.speed;
  }

  /* 発射 */
  if (keys["Space"]) {
    shoot(time);
  }

  /* 弾移動 */
  bullets.forEach(b => b.y -= b.speed);
  bullets = bullets.filter(b => b.y > -10);

  /* 敵移動 */
  enemies.forEach(e => e.y += e.speed);

  /* 敵が下に到達 */
  enemies = enemies.filter(e => {
    if (e.y > canvas.height + 20) {
      if (e.type !== "huku") {
        timeLeft -= 1;
      }
      return false;
    }
    return true;
  });

  /* 当たり判定 */
  bullets.forEach((b, bi) => {
    enemies.forEach((e, ei) => {
      if (
        b.x > e.x - e.width / 2 &&
        b.x < e.x + e.width / 2 &&
        b.y > e.y - e.height / 2 &&
        b.y < e.y + e.height / 2
      ) {
        if (e.type === "huku") {
          gameOver = true;
          return;
        }

        bullets.splice(bi, 1);
        enemies.splice(ei, 1);
        score += 100;
        timeLeft += 1;
      }
    });
  });

  /* 敵出現 */
  if (time - lastSpawnTime > spawnInterval) {
    spawnEnemy();
    lastSpawnTime = time;
  }

  /* 時間切れ */
  if (timeLeft <= 0) {
    gameOver = true;
  }
}

/* ===== 描画 ===== */
function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  /* プレイヤー */
  ctx.drawImage(
    playerImage,
    player.x - player.width / 2,
    player.y - player.height / 2,
    player.width,
    player.height
  );

  /* 弾 */
  ctx.fillStyle = "yellow";
  bullets.forEach(b => {
    ctx.beginPath();
    ctx.arc(b.x, b.y, b.radius, 0, Math.PI * 2);
    ctx.fill();
  });

  /* 敵 */
  enemies.forEach(e => {
    const img = e.type === "huku" ? hukuImage : oniImage;
    ctx.drawImage(
      img,
      e.x - e.width / 2,
      e.y - e.height / 2,
      e.width,
      e.height
    );
  });

  /* UI */
  ctx.fillStyle = "white";
  ctx.font = "16px sans-serif";
  ctx.textAlign = "left";
  ctx.fillText(`TIME: ${timeLeft}`, 10, 20);
  ctx.fillText(`SCORE: ${score}`, 10, 40);

  /* GAME OVER */
  if (gameOver) {
    ctx.fillStyle = "rgba(0,0,0,0.7)";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    ctx.fillStyle = "white";
    ctx.font = "28px sans-serif";
    ctx.textAlign = "center";
    ctx.fillText("GAME OVER", canvas.width / 2, canvas.height / 2 - 10);

    if (canvas.width < MIN_CANVAS_WIDTH) {
      ctx.font = "16px sans-serif";
      ctx.fillText(
        "WINDOW TOO SMALL",
        canvas.width / 2,
        canvas.height / 2 + 25
      );
    } else {
      ctx.font = "20px sans-serif";
      ctx.fillText(
        `SCORE: ${score}`,
        canvas.width / 2,
        canvas.height / 2 + 25
      );
    }
  }
}

/* ===== ループ ===== */
function loop(time) {
  update(time);
  draw();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

/* ===== 制限時間 ===== */
setInterval(() => {
  if (!gameOver) timeLeft -= 1;
}, 1000);
</script>

</body>
</html>
