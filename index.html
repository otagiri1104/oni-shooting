<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Oni Shooting</title>
<style>
  body {
    margin: 0;
    background: #111;
  }
  canvas {
    display: block;
    margin: auto;
    background: #000;
  }
</style>
</head>
<body>

<canvas id="game" width="400" height="600"></canvas>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  import { getFirestore } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";
  // ↑ これが抜けてた！！！

  const firebaseConfig = {
    apiKey: "AIzaSyBrKZwUQTSEXsw_TJIBwURvJ8MSdGaU2YQ",
    authDomain: "oni-shooting.firebaseapp.com",
    projectId: "oni-shooting",
    storageBucket: "oni-shooting.firebasestorage.app",
    messagingSenderId: "748207593961",
    appId: "1:748207593961:web:46fda8f55181537c845378"
  };

  const app = initializeApp(firebaseConfig);
  window.db = getFirestore(app);
</script>

<script>
console.log("db:", window.db);

  
/* ===== Canvas ===== */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

/* ===== 定数 ===== */
const MIN_CANVAS_WIDTH = 120;
const SHOT_INTERVAL = 250;

/* ===== 画像 ===== */
const oniImage = new Image();
oniImage.src = "teki.png";

const hukuImage = new Image();
hukuImage.src = "huku.png";

const playerImage = new Image();
playerImage.src = "onigiri.png";

/* ===== ゲーム状態 ===== */
let timeLeft = 30;
let score = 0;
let gameOver = false;
let paused = false;
let lastShotTime = 0;

/* ===== 名前入力状態 ===== */
let inputMode = false;
let playerName = "";
let nameFixed = false;

/* ===== キャンバスサイズロック ===== */
const lockedCanvasWidth = canvas.width;
const lockedCanvasHeight = canvas.height;

/* ===== プレイヤー ===== */
const player = {
  x: canvas.width / 2,
  y: canvas.height - 50,
  width: 48,
  height: 48,
  speed: 5
};

/* ===== 配列 ===== */
let bullets = [];
let enemies = [];

/* ===== 敵出現 ===== */
let spawnInterval = 1000;
let lastSpawnTime = 0;

/* ===== 入力 ===== */
const keys = {};
document.addEventListener("keydown", e => {

  /* ===== 名前入力モード ===== */
  if (gameOver && inputMode && !nameFixed) {
    if (e.key === "Backspace") {
      playerName = playerName.slice(0, -1);
      return;
    }

    if (e.key === "Enter") {
      if (playerName.length > 0) {
        nameFixed = true;
        inputMode = false;
      }
      return;
    }

    if (playerName.length < 10 && e.key.length === 1) {
      playerName += e.key;
      return;
    }
  }

  keys[e.code] = true;
});

document.addEventListener("keyup", e => {
  keys[e.code] = false;
});

/* ===== 弾 ===== */
function shoot(time) {
  if (time - lastShotTime < SHOT_INTERVAL) return;

  lastShotTime = time;
  bullets.push({
    x: player.x,
    y: player.y - player.height / 2,
    radius: 4,
    speed: 7
  });
}

/* ===== 敵生成 ===== */
function spawnEnemy() {
  const isHuku = Math.random() < 0.1;

  enemies.push({
    x: Math.random() * (canvas.width - 40) + 20,
    y: -40,
    width: 48,
    height: 48,
    speed: 1.5 + score / 1500,
    type: isHuku ? "huku" : "normal"
  });
}

/* ===== 更新 ===== */
function update(time) {
  if (gameOver) return;

  /* リサイズ検知 → 維持型一時停止 */
  paused =
    canvas.width !== lockedCanvasWidth ||
    canvas.height !== lockedCanvasHeight;

  if (paused) return;

  /* 開始時点の最小幅チェック */
  if (lockedCanvasWidth < MIN_CANVAS_WIDTH) {
    gameOver = true;
    inputMode = true;
    return;
  }

  /* 移動 */
  if (keys["ArrowLeft"] && player.x > player.width / 2) {
    player.x -= player.speed;
  }
  if (keys["ArrowRight"] && player.x < canvas.width - player.width / 2) {
    player.x += player.speed;
  }

  /* 発射 */
  if (keys["Space"]) {
    shoot(time);
  }

  /* 弾移動 */
  bullets.forEach(b => b.y -= b.speed);
  bullets = bullets.filter(b => b.y > -10);

  /* 敵移動 */
  enemies.forEach(e => e.y += e.speed);

  /* 敵が下に到達 */
  enemies = enemies.filter(e => {
    if (e.y > canvas.height + 20) {
      if (e.type !== "huku") {
        timeLeft -= 1;
      }
      return false;
    }
    return true;
  });

  /* 当たり判定 */
  bullets.forEach((b, bi) => {
    enemies.forEach((e, ei) => {
      if (
        b.x > e.x - e.width / 2 &&
        b.x < e.x + e.width / 2 &&
        b.y > e.y - e.height / 2 &&
        b.y < e.y + e.height / 2
      ) {
        if (e.type === "huku") {
          gameOver = true;
          inputMode = true;
          return;
        }

        bullets.splice(bi, 1);
        enemies.splice(ei, 1);
        score += 100;
        timeLeft += 1;
      }
    });
  });

  /* 敵出現 */
  if (time - lastSpawnTime > spawnInterval) {
    spawnEnemy();
    lastSpawnTime = time;
  }

  /* 時間切れ */
  if (timeLeft <= 0) {
    gameOver = true;
    inputMode = true;
  }
}

/* ===== 描画 ===== */
function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  /* プレイヤー */
  ctx.drawImage(
    playerImage,
    player.x - player.width / 2,
    player.y - player.height / 2,
    player.width,
    player.height
  );

  /* 弾 */
  ctx.fillStyle = "yellow";
  bullets.forEach(b => {
    ctx.beginPath();
    ctx.arc(b.x, b.y, b.radius, 0, Math.PI * 2);
    ctx.fill();
  });

  /* 敵 */
  enemies.forEach(e => {
    const img = e.type === "huku" ? hukuImage : oniImage;
    ctx.drawImage(
      img,
      e.x - e.width / 2,
      e.y - e.height / 2,
      e.width,
      e.height
    );
  });

  /* UI */
  ctx.fillStyle = "white";
  ctx.font = "16px sans-serif";
  ctx.textAlign = "left";
  ctx.fillText(`TIME: ${timeLeft}`, 10, 20);
  ctx.fillText(`SCORE: ${score}`, 10, 40);

  /* PAUSE */
  if (paused && !gameOver) {
    ctx.fillStyle = "rgba(0,0,0,0.6)";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    ctx.fillStyle = "white";
    ctx.font = "24px sans-serif";
    ctx.textAlign = "center";
    ctx.fillText(
      "PAUSED (SCREEN RESIZED)",
      canvas.width / 2,
      canvas.height / 2
    );
  }

  /* GAME OVER & 名前入力 */
  if (gameOver) {
    ctx.fillStyle = "rgba(0,0,0,0.7)";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    ctx.fillStyle = "white";
    ctx.textAlign = "center";

    ctx.font = "28px sans-serif";
    ctx.fillText("GAME OVER", canvas.width / 2, canvas.height / 2 - 60);

    ctx.font = "20px sans-serif";
    ctx.fillText(
      `SCORE: ${score}`,
      canvas.width / 2,
      canvas.height / 2 - 25
    );

    if (!nameFixed) {
      ctx.font = "18px sans-serif";
      ctx.fillText(
        "名前を入力してください",
        canvas.width / 2,
        canvas.height / 2 + 20
      );

      ctx.strokeStyle = "white";
      ctx.strokeRect(
        canvas.width / 2 - 120,
        canvas.height / 2 + 35,
        240,
        32
      );

      ctx.fillText(
        playerName || "_",
        canvas.width / 2,
        canvas.height / 2 + 60
      );

      ctx.font = "14px sans-serif";
      ctx.fillText(
        "Enterで確定 / Backspaceで削除",
        canvas.width / 2,
        canvas.height / 2 + 90
      );
    }

    if (nameFixed) {
      ctx.font = "20px sans-serif";
      ctx.fillText(
        `WELCOME, ${playerName}!`,
        canvas.width / 2,
        canvas.height / 2 + 40
      );
    }
  }
}

/* ===== ループ ===== */
function loop(time) {
  update(time);
  draw();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

/* ===== 制限時間 ===== */
setInterval(() => {
  if (!gameOver && !paused) {
    timeLeft -= 1;
  }
}, 1000);

</script>

</body>
</html>
